<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flights - FlightBook</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html"><h4>FlightBook</h4></a>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="flights.html">Flights</a></li>
          <li class="nav-item"><a class="nav-link active" href="bookings.html">Bookings</a></li>
          <!-- <li class="nav-item"><a class="nav-link" href="payment.html">Payment (Mock)</a></li> -->
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h2 class="mb-0">Flight search results</h2>
        <p class="text-muted small mb-0">Choose a flight and proceed to booking</p>
      </div>
      <div>
        <a href="index.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Back</a>
      </div>
    </div>
    <div id="results" class="mt-2"></div>
  </main>

  <!-- Booking Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingModalTitle">Booking Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="bookingModalOkBtn" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="detailModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="detailBookBtn">Book</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-light py-3 mt-auto">
    <div class="container text-center small">&copy; 2025 FlightBook</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const origin = params.get('origin') || '';
      const destination = params.get('destination') || '';
      const date = params.get('date') || '';
      renderFlightsList({ origin, destination, date });
    });

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    async function renderFlightsList({ origin, destination, date }) {
      const container = document.getElementById("results");
      container.innerHTML = `<div class="text-center p-3 text-muted">Loading flights...</div>`;

      try {
        const query = new URLSearchParams({ origin, destination, date });
        const res = await fetch(`/api/flights?${query.toString()}`);
        const flights = await res.json();

        if (!Array.isArray(flights) || flights.length === 0) {
          container.innerHTML = `<div class="alert alert-warning">No flights found.</div>`;
          return;
        }

        container.innerHTML = flights.map(f => {
          const flightDate = formatDate(f.flight_date);
          return `
          <div class="card mb-3 shadow-sm flight-card" onclick="showFlightDetail('${f.id}')">
            <div class="card-body d-flex align-items-center gap-3">
              <img src="${f.image}" alt="${f.flight_number}" class="flight-thumb">
              <div class="flex-grow-1">
                <h5 class="card-title mb-1">${f.flight_number}</h5>
                <p class="mb-0 text-muted">${f.origin_code} → ${f.destination_code}</p>
                <small>${flightDate} at ${f.depart_time}</small>
              </div>
              <div class="text-end">
                <h5 class="text-primary mb-1">฿${Number(f.price).toLocaleString()}</h5>
           <a href="booking.html?flight_id=${f.id}" class="btn btn-primary btn-sm" onclick="event.stopPropagation()">Book</a>
              </div>
            </div>
          </div>
          `;
        }).join("");

      } catch (err) {
        console.error("Error fetching flights:", err);
        container.innerHTML = `<div class="alert alert-danger">Failed to load flights from database.</div>`;
      }
    }

    let airportMap = {};

    async function loadAirports() {
      try {
        const res = await fetch('/api/airports');
        const airports = await res.json();
        airports.forEach(a => {
          airportMap[a.code] = `${a.name} (${a.code})`;
        });
      } catch (err) {
        console.error('Failed to load airports', err);
      }
    }


    document.addEventListener('DOMContentLoaded', loadAirports);

    async function showFlightDetail(flightId) {
      try {
        const res = await fetch(`/api/flights/${flightId}`);
        const f = await res.json();

        const flightDate = formatDate(f.flight_date);

        document.getElementById('detailModalTitle').textContent = f.flight_number;
        document.getElementById('detailModalBody').innerHTML = `
      <div class="d-flex gap-3 align-items-center p-3" 
           style="background-color:#f8f9fa; border:1px solid #dee2e6; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
        <img src="${f.image}" alt="${f.flight_number}" 
             style="width:180px;height:200px;object-fit:cover;border-radius:12px;border:1px solid #ccc;">
        <div style="flex:1;">
          <p><strong>From:</strong> ${airportMap[f.origin_code] || f.origin_code}</p>
          <p><strong>To:</strong> ${airportMap[f.destination_code] || f.destination_code}</p>
          <p><strong>Date:</strong> ${flightDate}</p>
          <p><strong>Departure Time:</strong> ${f.depart_time}</p>
          <p><strong>Price:</strong> <span class="text-primary">฿${Number(f.price).toLocaleString()}</span></p>
        </div>
      </div>
    `;

        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

        const detailBookBtn = document.getElementById('detailBookBtn');
        detailBookBtn.onclick = () => {
          window.location.href = `booking.html?flight_id=${f.id}`;
        };

        detailModal.show();
      } catch (err) {
        console.error("Error fetching flight detail:", err);
        alert("Failed to load flight details.");
      }
    }



  </script>
</body>

</html>
ไ